<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Riot Games Authorization</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0f1923 0%, #1a2332 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #ff4655 0%, #ff1744 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            box-shadow: 0 10px 30px rgba(255, 70, 85, 0.3);
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8892a6;
            font-size: 14px;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .step {
            margin-bottom: 24px;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: #ff4655;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 12px;
            font-size: 14px;
        }

        .step-title {
            font-weight: 600;
            font-size: 16px;
        }

        .step-description {
            color: #8892a6;
            font-size: 14px;
            line-height: 1.5;
            margin-left: 40px;
        }

        .region-selector {
            margin-bottom: 20px;
        }

        .region-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .region-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .region-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .region-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .region-btn.selected {
            background: rgba(255, 70, 85, 0.2);
            border-color: #ff4655;
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #ff4655 0%, #ff1744 100%);
            border: none;
            border-radius: 12px;
            padding: 16px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(255, 70, 85, 0.4);
            margin-top: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 70, 85, 0.5);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-box {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        .info-box .icon {
            margin-bottom: 8px;
            font-size: 20px;
        }

        .info-box .title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box .text {
            color: #8892a6;
            font-size: 13px;
            line-height: 1.5;
        }

        .loader {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loader.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ff4655;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-container {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .success-container.active {
            display: block;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
        }

        .error-container {
            display: none;
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        .error-container.active {
            display: block;
        }

        .error-title {
            font-weight: 600;
            color: #f44336;
            margin-bottom: 8px;
        }

        .error-text {
            font-size: 14px;
            color: #8892a6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üéÆ</div>
            <h1>Valorant Store Bot</h1>
            <div class="subtitle">–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Riot Games</div>
        </div>

        <div id="authForm" class="auth-container">
            <div class="region-selector">
                <label class="region-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω:</label>
                <div class="region-grid">
                    <button class="region-btn" data-region="eu">
                        üá™üá∫ Europe
                    </button>
                    <button class="region-btn" data-region="na">
                        üá∫üá∏ NA
                    </button>
                    <button class="region-btn" data-region="ap">
                        üåè Asia Pacific
                    </button>
                    <button class="region-btn" data-region="kr">
                        üá∞üá∑ Korea
                    </button>
                </div>
            </div>

            <div class="step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Riot"</div>
                </div>
                <div class="step-description">
                    –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É Riot Games
                </div>
            </div>

            <div class="step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç</div>
                </div>
                <div class="step-description">
                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—à email/username –∏ –ø–∞—Ä–æ–ª—å. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è 2FA
                </div>
            </div>

            <div class="step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">–ì–æ—Ç–æ–≤–æ!</div>
                </div>
                <div class="step-description">
                    –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –≤—ã –≤–µ—Ä–Ω–µ—Ç–µ—Å—å –æ–±—Ä–∞—Ç–Ω–æ, –∏ —Ç–æ–∫–µ–Ω—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ –±–æ—Ç–∞
                </div>
            </div>

            <button id="loginBtn" class="login-btn" disabled>
                üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Riot Games
            </button>

            <div class="info-box">
                <div class="icon">üîí</div>
                <div class="title">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>
                <div class="text">
                    –í–∞—à –ø–∞—Ä–æ–ª—å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ã Riot Games. 
                    –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞ –∏ –Ω–µ –≤–∏–¥–∏—Ç –≤–∞—à –ø–∞—Ä–æ–ª—å.
                </div>
            </div>

            <div id="errorContainer" class="error-container">
                <div class="error-title">‚ùå –û—à–∏–±–∫–∞</div>
                <div class="error-text" id="errorText"></div>
            </div>
        </div>

        <div id="loader" class="loader">
            <div class="spinner"></div>
            <div style="color: #8892a6;">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</div>
        </div>

        <div id="successContainer" class="success-container">
            <div class="success-icon">‚úì</div>
            <h2>–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!</h2>
            <p style="color: #8892a6; margin-top: 10px;">
                –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç–∞. –ú–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ –æ–∫–Ω–æ.
            </p>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        document.body.style.background = tg.themeParams.bg_color || document.body.style.background;

        let selectedRegion = null;

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤–µ—Ä–Ω—É–ª–∏—Å—å –ª–∏ –º—ã –ø–æ—Å–ª–µ OAuth
        window.addEventListener('DOMContentLoaded', () => {
            checkForOAuthCallback();
        });

        function checkForOAuthCallback() {
            const hash = window.location.hash;
            
            // –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å access_token - –∑–Ω–∞—á–∏—Ç –≤–µ—Ä–Ω—É–ª–∏—Å—å –ø–æ—Å–ª–µ OAuth
            if (hash && hash.includes('access_token=')) {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–≥–∏–æ–Ω
                selectedRegion = localStorage.getItem('valorant_region');
                
                if (!selectedRegion) {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.');
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loader
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('loader').classList.add('active');
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã
                processOAuthCallback(hash);
            }
        }

        async function processOAuthCallback(hash) {
            try {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω—ã –∏–∑ hash
                const hashParams = hash.substring(1); // —É–±–∏—Ä–∞–µ–º #
                const params = new URLSearchParams(hashParams);
                
                const accessToken = params.get('access_token');
                const idToken = params.get('id_token');

                if (!accessToken) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞');
                }

                // –ü–æ–ª—É—á–∞–µ–º entitlement token
                const entitlementToken = await getEntitlementToken(accessToken);

                if (!entitlementToken) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å entitlement token');
                }

                // –ü–æ–ª—É—á–∞–µ–º PUUID –∏–∑ —Ç–æ–∫–µ–Ω–∞
                const puuid = extractPUUID(accessToken);

                if (!puuid) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å PUUID');
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–æ—Ç–∞
                const data = {
                    region: selectedRegion,
                    access_token: accessToken,
                    entitlement_token: entitlementToken,
                    puuid: puuid
                };

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Telegram WebApp API
                tg.sendData(JSON.stringify(data));

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                document.getElementById('loader').classList.remove('active');
                document.getElementById('successContainer').classList.add('active');

                // –û—á–∏—â–∞–µ–º localStorage
                localStorage.removeItem('valorant_region');

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    tg.close();
                }, 2000);

            } catch (error) {
                console.error('OAuth callback error:', error);
                showError(error.message);
                document.getElementById('loader').classList.remove('active');
                document.getElementById('authForm').style.display = 'block';
                
                // –û—á–∏—â–∞–µ–º URL –æ—Ç —Ç–æ–∫–µ–Ω–æ–≤
                window.location.hash = '';
                localStorage.removeItem('valorant_region');
            }
        }

        // –í—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞
        document.querySelectorAll('.region-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedRegion = btn.dataset.region;
                document.getElementById('loginBtn').disabled = false;
            });
        });

        // –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞
        document.getElementById('loginBtn').addEventListener('click', async () => {
            if (!selectedRegion) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω');
                return;
            }

            try {
                hideError();
                startAuth();
            } catch (error) {
                showError(error.message);
            }
        });

        function startAuth() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–≥–∏–æ–Ω –≤ localStorage –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
            localStorage.setItem('valorant_region', selectedRegion);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loader
            document.getElementById('authForm').style.display = 'none';
            document.getElementById('loader').classList.add('active');

            // –°–æ–∑–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è OAuth
            const clientId = 'play-valorant-web-prod';
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π URL –∫–∞–∫ redirect (–¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—é–¥–∞)
            const redirectUri = window.location.href.split('#')[0];
            const responseType = 'token id_token';
            const scope = 'account openid';
            const nonce = Math.random().toString(36).substring(7);

            // URL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Riot
            const authUrl = `https://auth.riotgames.com/authorize?` +
                `client_id=${clientId}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `response_type=${responseType}&` +
                `scope=${encodeURIComponent(scope)}&` +
                `nonce=${nonce}`;

            // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Riot
            // Riot –≤–µ—Ä–Ω–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ —Å—é–¥–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ URL hash
            window.location.href = authUrl;
        }

        async function getEntitlementToken(accessToken) {
            try {
                const response = await fetch('https://entitlements.auth.riotgames.com/api/token/v1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å entitlement token');
                }

                const data = await response.json();
                return data.entitlements_token;

            } catch (error) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ entitlement token: ' + error.message);
            }
        }

        function extractPUUID(accessToken) {
            try {
                const parts = accessToken.split('.');
                const payload = parts[1];
                const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
                const data = JSON.parse(decoded);
                return data.sub;
            } catch (error) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å PUUID –∏–∑ —Ç–æ–∫–µ–Ω–∞');
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorContainer.classList.add('active');
        }

        function hideError() {
            document.getElementById('errorContainer').classList.remove('active');
        }

    </script>
</body>
</html>
